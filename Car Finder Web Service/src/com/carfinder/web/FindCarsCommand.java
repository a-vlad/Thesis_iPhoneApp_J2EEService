package com.carfinder.web;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.ArrayList;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.carfinder.beans.ResultCarBean;
import com.carfinder.beans.SearchCriteriaBean;
import com.carfinder.db.DBController;
import com.carfinder.xml.CarFinderXMLParser;


public class FindCarsCommand implements Command {
	
	
	
	/** Creates a new instance of LoginCommand */
	public FindCarsCommand() {
		//memberServices = new MemberServices();
	}
	
	@Override
	public String execute(HttpServletRequest request, HttpServletResponse response) 
	throws ServletException, IOException {
		try {
			
			//Attribute to Bean conversion
			SearchCriteriaBean criteria = new SearchCriteriaBean();
			criteria.setCarFormFactor(request.getParameter("carFormFactor"));
			criteria.setMaxPrice(Double.valueOf(request.getParameter("maxPrice")));
			criteria.setEco(Float.valueOf(request.getParameter("eco")));
			criteria.setEnv(Float.valueOf(request.getParameter("env")));
			criteria.setLux(Float.valueOf(request.getParameter("lux")));
			criteria.setPrf(Float.valueOf(request.getParameter("prf")));
			criteria.setSaf(Float.valueOf(request.getParameter("saf")));
			criteria.setSiz(Float.valueOf(request.getParameter("siz")).intValue());
			criteria.setTow(Float.valueOf(request.getParameter("tow")));
			//NOTE: These are set by server for now, may be modifiable by app in future
			criteria.setNumberOfResults(NO_OF_RESULTS);
			criteria.setNumberOfCriteria(NO_OF_RESULT_SUGGESTIONS);
			
			PrintWriter out = response.getWriter();
			
			//Execute query in database if the values are all valid
			if (!criteria.isValid()) return "/error.jsp=parameter_error_findcars";
			
			ArrayList<ResultCarBean> cars = null;
			//cars = DBController.getCarMatches(criteria);
			
			//XML Encapsulasation and sending
			response.setContentType("text/xml;charset=UTF-8");
			
			//Handles server errors where no cars have been returned
			if ((cars == null) || (cars.isEmpty())){
				//out.write("<matches>  </matches>");	//Empty result list
				out.write("<matches><car><id>775544920100108</id><year>2010</year><make>MERCEDES</make><model>B-CLASS</model><bestat></bestat><transmission>M</transmission><bodystyle>Mini MPV</bodystyle><doors>5</doors><version>B 180</version><price>36990</price><photoURL>5MM</photoURL><tradeoff><spec1>FamilyValue</spec1><spec1dir>UP</spec1dir><spec2>PerformanceValue</spec2><spec2dir>DOWN</spec2dir><vids>755865520091002,786021220091203,715704920090109,64333920100104,742617220080402</vids></tradeoff><tradeoff><spec1>PerformanceValue</spec1><spec1dir>DOWN</spec1dir><spec2>GreenValue</spec2><spec2dir>UP</spec2dir><vids>755865520091002,786021220091203,715706120100219,715704920090109,64323920091217</vids></tradeoff><tradeoff><spec1>PerformanceValue</spec1><spec1dir>DOWN</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>72001620090513,744114120091013,15862520090901,47715920091201</vids></tradeoff><tradeoff><spec1>GreenValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>15892120090601,64333720100104,740475420091002,64349020100104,72023820090731</vids></tradeoff><seats>5</seats><cyl>4</cyl><engsiz>1.7</engsiz><engpow>85.0</engpow><safrat>0.0</safrat><weight>1330</weight><vid_url><![CDATA[http://www.youtube.com/watch?v=4u1cMvp5Ngw&feature=youtube_gdata_player]]></vid_url><review_url><![CDATA[http://news.drive.com.au/drive/motor-news/holden-commodore-vz-lumina-20100824-13nuc.html]]></review_url><specs_url><![CDATA[http://redbook.com.au/cars/research/new/details?R=635573&Silo=spec&Vertical=car&Ridx=0&eapi=2]]></specs_url></car><car><id>65207620090701</id><year>2009</year><make>MERCEDES</make><model>A-CLASS</model><bestat></bestat><transmission>M</transmission><bodystyle>Mini MPV</bodystyle><doors>5</doors><version>A 170</version><price>37900</price><photoURL>5MM</photoURL><tradeoff><spec1>FamilyValue</spec1><spec1dir>UP</spec1dir><spec2>TowValue</spec2><spec2dir>UP</spec2dir><vids>786021220091203,715704920090109,786532020100101,15865120091204,784885320091013</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>LuxuryValue</spec2><spec2dir>UP</spec2dir><vids>47727520091217,775161820090921,81842620091204,740479220100219,735196920091009</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>752609120091214,740474520091029,760887020091201,47750820090109,752606920090805</vids></tradeoff><tradeoff><spec1>LuxuryValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>UP</spec2dir><vids>748158920090324,64324020090513,15907120091217,775161920090921,76103120100101</vids></tradeoff><seats>5</seats><cyl>4</cyl><engsiz>1.7</engsiz><engpow>85.0</engpow><safrat>0.0</safrat><weight>1240</weight><vid_url><![CDATA[http://www.youtube.com/watch?v=jb_tumsQz3Q&feature=youtube_gdata_player]]></vid_url><review_url><![CDATA[http://news.drive.com.au/drive/motor-news/holden-commodore-vz-lumina-20100824-13nuc.html]]></review_url><specs_url><![CDATA[http://redbook.com.au/cars/research/new/details?R=635573&Silo=spec&Vertical=car&Ridx=0&eapi=2]]></specs_url></car><car><id>755862620091201</id><year>2010</year><make>SKODA</make><model>ROOMSTER</model><bestat></bestat><transmission>M</transmission><bodystyle>Mini MPV</bodystyle><doors>5</doors><version>1.6 STYLE</version><price>25990</price><photoURL>5MM</photoURL><tradeoff><spec1>FamilyValue</spec1><spec1dir>UP</spec1dir><spec2>Size</spec2><spec2dir>UP</spec2dir><vids>755865520091002,786021220091203,715704920090109,64323920091217,64333920100104</vids></tradeoff><tradeoff><spec1>Size</spec1><spec1dir>UP</spec1dir><spec2>SafetyValue</spec2><spec2dir>UP</spec2dir><vids>755865520091002,786021220091203,715704920090109,64323920091217,64324020090513</vids></tradeoff><tradeoff><spec1>Size</spec1><spec1dir>DOWN</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>65207620090701,76112920090601</vids></tradeoff><tradeoff><spec1>SafetyValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>752609120091214,64333720100104,740475420091002,15928720100216,734990520090109</vids></tradeoff><seats>5</seats><cyl>4</cyl><engsiz>1.6</engsiz><engpow>77.0</engpow><safrat>0.0</safrat><weight>1175</weight><vid_url><![CDATA[http://www.youtube.com/watch?v=gC08RY-OtcU&feature=youtube_gdata_player]]></vid_url><review_url><![CDATA[http://news.drive.com.au/drive/motor-news/holden-commodore-vz-lumina-20100824-13nuc.html]]></review_url><specs_url><![CDATA[http://redbook.com.au/cars/research/new/details?R=635573&Silo=spec&Vertical=car&Ridx=0&eapi=2]]></specs_url></car><car><id>76119220091001</id><year>2009</year><make>CHRYSLER</make><model>PT CRUISER</model><bestat></bestat><transmission>M</transmission><bodystyle>Mini MPV</bodystyle><doors>5</doors><version>2.4 TOURING</version><price>31490</price><photoURL>5MM</photoURL><tradeoff><spec1>FamilyValue</spec1><spec1dir>UP</spec1dir><spec2>PerformanceValue</spec2><spec2dir>DOWN</spec2dir><vids>755865520091002,786021220091203,715704920090109,64333920100104,742617220080402</vids></tradeoff><tradeoff><spec1>PerformanceValue</spec1><spec1dir>DOWN</spec1dir><spec2>LuxuryValue</spec2><spec2dir>UP</spec2dir><vids>64324020090513,775161820090921,15907120091217,65207620090701,76103120100101</vids></tradeoff><tradeoff><spec1>PerformanceValue</spec1><spec1dir>DOWN</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>72001620090513,744114120091013,15862520090901,47715920091201</vids></tradeoff><tradeoff><spec1>LuxuryValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>UP</spec2dir><vids>748158920090324,64324020090513,15907120091217,775161920090921,76103120100101</vids></tradeoff><seats>5</seats><cyl>4</cyl><engsiz>2.4</engsiz><engpow>105.0</engpow><safrat>0.0</safrat><weight>1435</weight><vid_url><![CDATA[http://www.youtube.com/watch?v=QBcfVupx2ZU&feature=youtube_gdata_player]]></vid_url><review_url><![CDATA[http://news.drive.com.au/drive/motor-news/holden-commodore-vz-lumina-20100824-13nuc.html]]></review_url><specs_url><![CDATA[http://redbook.com.au/cars/research/new/details?R=635573&Silo=spec&Vertical=car&Ridx=0&eapi=2]]></specs_url></car><car><id>76112920090601</id><year>2009</year><make>MITSUBISHI</make><model>COLT</model><bestat></bestat><transmission>A</transmission><bodystyle>Mini MPV</bodystyle><doors>5</doors><version>1.5 VRX CVT</version><price>18490</price><photoURL>5MM</photoURL><tradeoff><spec1>FamilyValue</spec1><spec1dir>UP</spec1dir><spec2>EconomyValue</spec2><spec2dir>UP</spec2dir><vids>755865520091002,786021220091203,715706120100219,715704920090109,64323920091217</vids></tradeoff><tradeoff><spec1>EconomyValue</spec1><spec1dir>UP</spec1dir><spec2>SafetyValue</spec2><spec2dir>UP</spec2dir><vids>755865520091002,786021220091203,715706120100219,715704920090109,64323920091217</vids></tradeoff><tradeoff><spec1>EconomyValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>15892120090601,64333720100104,740475420091002,64349020100104,72023820090731</vids></tradeoff><tradeoff><spec1>SafetyValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>752609120091214,64333720100104,740475420091002,15928720100216,734990520090109</vids></tradeoff><seats>5</seats><cyl>4</cyl><engsiz>1.5</engsiz><engpow>77.0</engpow><safrat>0.0</safrat><weight>1074</weight><vid_url><![CDATA[http://www.youtube.com/watch?v=iT9ISCsBgb0&feature=youtube_gdata_player]]></vid_url><review_url><![CDATA[http://news.drive.com.au/drive/motor-news/holden-commodore-vz-lumina-20100824-13nuc.html]]></review_url><specs_url><![CDATA[http://redbook.com.au/cars/research/new/details?R=635573&Silo=spec&Vertical=car&Ridx=0&eapi=2]]></specs_url></car><car><id>764959320091201</id><year>2009</year><make>HONDA</make><model>CITY</model><bestat></bestat><transmission>M</transmission><bodystyle>sedan</bodystyle><doors>4</doors><version>1.5 VTI</version><price>19490</price><photoURL>4SA</photoURL><tradeoff><spec1>FamilyValue</spec1><spec1dir>UP</spec1dir><spec2>EconomyValue</spec2><spec2dir>UP</spec2dir><vids>64324020090513,792533020100125,64365420100211,15907120091217,70356620100216</vids></tradeoff><tradeoff><spec1>EconomyValue</spec1><spec1dir>UP</spec1dir><spec2>TowValue</spec2><spec2dir>UP</spec2dir><vids>792533220100125,47726920091217,760887020091201,752606920090805,775545620100214</vids></tradeoff><tradeoff><spec1>EconomyValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>15892120090601,64333720100104,740475420091002,64349020100104,72023820090731</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>752609120091214,740474520091029,760887020091201,47750820090109,752606920090805</vids></tradeoff><seats>5</seats><cyl>4</cyl><engsiz>1.5</engsiz><engpow>88.0</engpow><safrat>0.0</safrat><weight>1110</weight><vid_url><![CDATA[http://www.youtube.com/watch?v=ATx-9wfE44E&feature=youtube_gdata_player]]></vid_url><review_url><![CDATA[http://news.drive.com.au/drive/motor-news/holden-commodore-vz-lumina-20100824-13nuc.html]]></review_url><specs_url><![CDATA[http://redbook.com.au/cars/research/new/details?R=635573&Silo=spec&Vertical=car&Ridx=0&eapi=2]]></specs_url></car><car><id>70396420100301</id><year>2010</year><make>NISSAN</make><model>TIIDA</model><bestat></bestat><transmission>M</transmission><bodystyle>sedan</bodystyle><doors>4</doors><version>1.8 ST</version><price>17990</price><photoURL>4SA</photoURL><tradeoff><spec1>FamilyValue</spec1><spec1dir>UP</spec1dir><spec2>TowValue</spec2><spec2dir>UP</spec2dir><vids>792533220100125,64323920091217,752262620090112,47726920091217,760887020091201</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>GreenValue</spec2><spec2dir>UP</spec2dir><vids>792533220100125,64323920091217,752262620090112,47726920091217,760887020091201</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>752609120091214,740474520091029,760887020091201,47750820090109,752606920090805</vids></tradeoff><tradeoff><spec1>GreenValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>15892120090601,64333720100104,740475420091002,64349020100104,72023820090731</vids></tradeoff><seats>5</seats><cyl>4</cyl><engsiz>1.8</engsiz><engpow>93.0</engpow><safrat>0.0</safrat><weight>1136</weight><vid_url><![CDATA[http://www.youtube.com/watch?v=j4s9BTn6NA0&feature=youtube_gdata_player]]></vid_url><review_url><![CDATA[http://news.drive.com.au/drive/motor-news/holden-commodore-vz-lumina-20100824-13nuc.html]]></review_url><specs_url><![CDATA[http://redbook.com.au/cars/research/new/details?R=635573&Silo=spec&Vertical=car&Ridx=0&eapi=2]]></specs_url></car></matches>");

				return "/error.jsp=parameter_error_findcars";
			}else{
				out.write(CarFinderXMLParser.getXMLMatchFromBean(cars));
				//out.write("<matches><car><id>775544920100108</id><year>2010</year><make>MERCEDES</make><model>B-CLASS</model><version>B 180</version><price>36990</price><photoURL>5MM</photoURL><tradeoff><spec1>CityValue</spec1><spec1dir>UP</spec1dir><spec2>TowValue</spec2><spec2dir>UP</spec2dir><vids>744113220091112,770427820100128,740479020100301,81801020100113,742612920090604</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>LuxuryValue</spec2><spec2dir>DOWN</spec2dir><vids>742615220090501,752609720090406,744113220091112,740479020100301,81801020100113</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>784888820100201,743141620100301,760014920090324,714956320100101,758742220080602</vids></tradeoff><tradeoff><spec1>LuxuryValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>UP</spec2dir><vids>752260420090701,770427720100128,714952120100201,72078120100101,755868520091120</vids></tradeoff></car><car><id>65207620090701</id><year>2009</year><make>MERCEDES</make><model>A-CLASS</model><version>A 170</version><price>37900</price><photoURL>5MM</photoURL><tradeoff><spec1>CityValue</spec1><spec1dir>UP</spec1dir><spec2>TowValue</spec2><spec2dir>UP</spec2dir><vids>744113220091112,770427820100128,740479020100301,81801020100113,742612920090604</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>LuxuryValue</spec2><spec2dir>DOWN</spec2dir><vids>742615220090501,752609720090406,744113220091112,740479020100301,81801020100113</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>784888820100201,743141620100301,760014920090324,714956320100101,758742220080602</vids></tradeoff><tradeoff><spec1>LuxuryValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>UP</spec2dir><vids>752260420090701,770427720100128,714952120100201,72078120100101,755868520091120</vids></tradeoff></car><car><id>755862620091201</id><year>2010</year><make>SKODA</make><model>ROOMSTER</model><version>1.6 STYLE</version><price>25990</price><photoURL>5MM</photoURL><tradeoff><spec1>CityValue</spec1><spec1dir>UP</spec1dir><spec2>TowValue</spec2><spec2dir>UP</spec2dir><vids>744113220091112,770427820100128,740479020100301,81801020100113,742612920090604</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>LuxuryValue</spec2><spec2dir>DOWN</spec2dir><vids>742615220090501,752609720090406,744113220091112,740479020100301,81801020100113</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>784888820100201,743141620100301,760014920090324,714956320100101,758742220080602</vids></tradeoff><tradeoff><spec1>LuxuryValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>UP</spec2dir><vids>752260420090701,770427720100128,714952120100201,72078120100101,755868520091120</vids></tradeoff></car><car><id>76119220091001</id><year>2009</year><make>CHRYSLER</make><model>PT CRUISER</model><version>2.4 TOURING</version><price>31490</price><photoURL>5MM</photoURL><tradeoff><spec1>CityValue</spec1><spec1dir>UP</spec1dir><spec2>TowValue</spec2><spec2dir>UP</spec2dir><vids>744113220091112,770427820100128,740479020100301,81801020100113,742612920090604</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>LuxuryValue</spec2><spec2dir>DOWN</spec2dir><vids>742615220090501,752609720090406,744113220091112,740479020100301,81801020100113</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>784888820100201,743141620100301,760014920090324,714956320100101,758742220080602</vids></tradeoff><tradeoff><spec1>LuxuryValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>UP</spec2dir><vids>752260420090701,770427720100128,714952120100201,72078120100101,755868520091120</vids></tradeoff></car><car><id>76112920090601</id><year>2009</year><make>MITSUBISHI</make><model>COLT</model><version>1.5 VRX CVT</version><price>18490</price><photoURL>5MM</photoURL><tradeoff><spec1>PerformanceValue</spec1><spec1dir>UP</spec1dir><spec2>TowValue</spec2><spec2dir>UP</spec2dir><vids>744113220091112,770427820100128,740479020100301,81801020100113,742612920090604</vids></tradeoff><tradeoff><spec1>SizeValue</spec1><spec1dir>UP</spec1dir><spec2>LuxuryValue</spec2><spec2dir>DOWN</spec2dir><vids>742615220090501,752609720090406,744113220091112,740479020100301,81801020100113</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>784888820100201,743141620100301,760014920090324,714956320100101,758742220080602</vids></tradeoff><tradeoff><spec1>LuxuryValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>UP</spec2dir><vids>752260420090701,770427720100128,714952120100201,72078120100101,755868520091120</vids></tradeoff></car><car><id>764959320091201</id><year>2009</year><make>HONDA</make><model>CITY</model><version>1.5 VTI</version><price>19490</price><photoURL>5SA</photoURL><tradeoff><spec1>CityValue</spec1><spec1dir>UP</spec1dir><spec2>TowValue</spec2><spec2dir>UP</spec2dir><vids>744113220091112,770427820100128,740479020100301,81801020100113,742612920090604</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>LuxuryValue</spec2><spec2dir>DOWN</spec2dir><vids>742615220090501,752609720090406,744113220091112,740479020100301,81801020100113</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>784888820100201,743141620100301,760014920090324,714956320100101,758742220080602</vids></tradeoff><tradeoff><spec1>LuxuryValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>UP</spec2dir><vids>752260420090701,770427720100128,714952120100201,72078120100101,755868520091120</vids></tradeoff></car><car><id>70396420100301</id><year>2010</year><make>NISSAN</make><model>TIIDA</model><version>1.8 ST</version><price>17990</price><photoURL>5SA</photoURL><tradeoff><spec1>CityValue</spec1><spec1dir>UP</spec1dir><spec2>TowValue</spec2><spec2dir>UP</spec2dir><vids>744113220091112,770427820100128,740479020100301,81801020100113,742612920090604</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>LuxuryValue</spec2><spec2dir>DOWN</spec2dir><vids>742615220090501,752609720090406,744113220091112,740479020100301,81801020100113</vids></tradeoff><tradeoff><spec1>TowValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>DOWN</spec2dir><vids>784888820100201,743141620100301,760014920090324,714956320100101,758742220080602</vids></tradeoff><tradeoff><spec1>LuxuryValue</spec1><spec1dir>UP</spec1dir><spec2>Price</spec2><spec2dir>UP</spec2dir><vids>752260420090701,770427720100128,714952120100201,72078120100101,755868520091120</vids></tradeoff></car></matches>");
			}			
			
		} catch (Exception e) {
			e.printStackTrace();
			return "/error.jsp=parameter_match_error";
		}
	
		
		return "/parameter_matches.xml";
		
	}
}
